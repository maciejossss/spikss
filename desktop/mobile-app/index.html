<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serwis Mobilny</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Wymu≈õ od≈õwie≈ºenie cache
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for(let registration of registrations) {
                        registration.unregister();
                        console.log('üóëÔ∏è Stary SW usuniƒôty');
                    }
                });
                
                // Zarejestruj nowy SW
                navigator.serviceWorker.register('/sw.js?v=1.0.3')
                    .then(registration => {
                        console.log('üì± SW zarejestrowany:', registration);
                        // Wymu≈õ od≈õwie≈ºenie
                        registration.update();
                    })
                    .catch(registrationError => {
                        console.log('üì± SW b≈ÇƒÖd rejestracji:', registrationError);
                    });
            });
        }
    </script>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Serwis Mobilny">
    
    <!-- CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 0;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn-success {
            background: #059669;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-new {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .status-in_progress {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #059669;
        }
        
        .priority-high {
            border-left: 4px solid #dc2626;
        }
        
        .priority-medium {
            border-left: 4px solid #d97706;
        }
        
        .priority-low {
            border-left: 4px solid #059669;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #fecaca;
        }
        
        .connection-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .connected {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }
        
        .disconnected {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .timer {
            background: #1e293b;
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin: 16px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        h1, h2, h3 {
            margin-bottom: 12px;
        }
        
        p {
            margin-bottom: 8px;
        }
        
        .order-item {
            margin-bottom: 16px;
            transition: transform 0.2s;
        }
        
        .order-item:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîß Serwis Mobilny</h1>
            <p>Aplikacja dla technik√≥w</p>
        </div>
        
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status">
            Sprawdzanie po≈ÇƒÖczenia...
        </div>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="card">
            <h2>Logowanie Technika</h2>
            <p>Wybierz swojego u≈ºytkownika:</p>
            <div id="techniciansList"></div>
            <button class="btn" onclick="testConnection()">üîÑ Sprawd≈∫ po≈ÇƒÖczenie</button>
            <button class="btn btn-success" onclick="forceRefresh()">üîÑ Wymu≈õ od≈õwie≈ºenie</button>
        </div>
        
        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- Current Work Timer -->
            <div id="workTimer" class="timer hidden">
                <div>‚è±Ô∏è Czas pracy</div>
                <div id="timerDisplay">00:00:00</div>
                <div id="currentOrderTitle"></div>
            </div>
            
            <!-- Orders List -->
            <div class="card">
                <h2>üìã Moje zlecenia</h2>
                <div id="ordersList">
                    <div class="loading">≈Åadowanie zlece≈Ñ...</div>
                </div>
                <button class="btn" onclick="refreshOrders()">üîÑ Od≈õwie≈º</button>
            </div>
            
            <!-- Logout -->
            <button class="btn btn-danger" onclick="logout()">üö™ Wyloguj</button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ‚òÅÔ∏è CENTRALNA BAZA DANYCH - Mobile app ZAWSZE u≈ºywa Railway
        const API_CONFIG = {
            base: 'https://web-production-fc58d.up.railway.app/api',
            environment: 'railway'
        };
        
        console.log('‚òÅÔ∏è Mobile app u≈ºywa centralnej bazy Railway');
        console.log('üì± Wszystkie telefony ≈ÇƒÖczƒÖ siƒô z tym samym API');
        console.log('üåç Niezale≈ºnie od lokalizacji desktop aplikacji');
        
        // Backward compatibility
        const API_BASE = API_CONFIG.base;
        
        let currentTechnician = null;
        let currentOrders = [];
        let workTimer = null;
        let workStartTime = null;
        
        // Stan aplikacji
        const app = {
            isConnected: false,
            currentOrder: null
        };
        
        // Inicjalizacja aplikacji
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Aplikacja mobilna uruchomiona');
            checkConnection();
            loadTechnicians();
            
            // Sprawd≈∫ czy jest zapisany technik
            const savedTechnicianId = localStorage.getItem('technicianId');
            if (savedTechnicianId) {
                currentTechnician = { id: parseInt(savedTechnicianId) };
                showMainApp();
                loadOrders();
            }
        });
        
        // Sprawdzenie po≈ÇƒÖczenia z API
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    app.isConnected = true;
                    updateConnectionStatus(true, 'Po≈ÇƒÖczono z serwerem');
                    console.log('‚úÖ Po≈ÇƒÖczenie OK:', data);
                } else {
                    throw new Error('B≈ÇƒÖd serwera');
                }
            } catch (error) {
                app.isConnected = false;
                updateConnectionStatus(false, 'Brak po≈ÇƒÖczenia z serwerem');
                console.error('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia:', error);
            }
        }
        
        // Aktualizacja statusu po≈ÇƒÖczenia
        function updateConnectionStatus(connected, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = message;
            statusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        // ≈Åadowanie listy technik√≥w
        async function loadTechnicians() {
            try {
                const response = await fetch(`${API_BASE}/technicians`);
                const technicians = await response.json();
                
                const listEl = document.getElementById('techniciansList');
                listEl.innerHTML = '';
                
                technicians.forEach(tech => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.textContent = `üë§ ${tech.full_name}`;
                    btn.setAttribute('data-tech-id', tech.id);
                    btn.onclick = () => loginAsTechnician(tech);
                    listEl.appendChild(btn);
                });
                
                console.log('üë• Za≈Çadowano technik√≥w:', technicians);
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd ≈Çadowania technik√≥w:', error);
                showError('Nie mo≈ºna za≈Çadowaƒá listy technik√≥w');
            }
        }
        
        // Logowanie jako technik
        function loginAsTechnician(technician) {
            currentTechnician = technician;
            localStorage.setItem('technicianId', technician.id);
            showMainApp();
            loadOrders();
            console.log('üîë Zalogowano jako:', technician.full_name);
        }
        
        // Wylogowanie
        function logout() {
            currentTechnician = null;
            localStorage.removeItem('technicianId');
            stopWorkTimer();
            showLoginScreen();
            console.log('üö™ Wylogowano');
        }
        
        // Prze≈ÇƒÖczenie na g≈Ç√≥wny ekran
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }
        
        // Prze≈ÇƒÖczenie na ekran logowania
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
        
        // Prze≈ÇƒÖczenie na ekran wyboru technika
        function showTechnicianSelect() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            loadTechnicians(); // Od≈õwie≈º listƒô technik√≥w
        }
        
        // ≈Åadowanie zlece≈Ñ
        async function loadOrders() {
            if (!currentTechnician) return;
            
            try {
                const response = await fetch(`${API_BASE}/desktop/orders/${currentTechnician.id}`);
                const orders = await response.json();
                
                currentOrders = orders;
                renderOrders(orders);
                console.log(`üìã Za≈Çadowano ${orders.length} zlece≈Ñ`);
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd ≈Çadowania zlece≈Ñ:', error);
                showError('Nie mo≈ºna za≈Çadowaƒá zlece≈Ñ');
            }
        }
        
        // Renderowanie listy zlece≈Ñ
        function renderOrders(orders) {
            const listEl = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #64748b;">Brak zlece≈Ñ do wykonania</p>';
                return;
            }
            
            listEl.innerHTML = orders.map(order => `
                <div class="order-item card priority-${order.priority || 'medium'}">
                    <h3>${order.title}</h3>
                    <p><strong>Klient:</strong> ${order.client_name}</p>
                    <p><strong>Adres:</strong> ${order.address || 'Brak adresu'}</p>
                    <p><strong>Priorytet:</strong> ${order.priority || 'medium'}</p>
                    <div style="margin: 12px 0;">
                        <span class="status status-${order.status}">${getStatusLabel(order.status)}</span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${order.status === 'new' ? 
                            `<button class="btn btn-success" onclick="startWork(${order.id}, '${order.title}')">‚ñ∂Ô∏è Rozpocznij</button>` :
                            order.status === 'in_progress' ? 
                                `<button class="btn btn-danger" onclick="completeWork(${order.id})">‚úÖ Zako≈Ñcz</button>` : ''
                        }
                    </div>
                </div>
            `).join('');
        }
        
        // Rozpoczƒôcie pracy
        async function startWork(orderId, orderTitle) {
            try {
                const response = await fetch(`${API_BASE}/desktop/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'in_progress'
                    })
                });
                
                if (response.ok) {
                    app.currentOrder = { id: orderId, title: orderTitle };
                    startWorkTimer(orderTitle);
                    refreshOrders();
                    console.log('üöÄ Rozpoczƒôto pracƒô nad zleceniem:', orderId);
                } else {
                    throw new Error('B≈ÇƒÖd serwera');
                }
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd rozpoczynania pracy:', error);
                showError('Nie mo≈ºna rozpoczƒÖƒá pracy');
            }
        }
        
        // Zako≈Ñczenie pracy
        async function completeWork(orderId) {
            const notes = prompt('Dodaj notatki z wykonanej pracy (opcjonalnie):') || '';
            
            try {
                const response = await fetch(`${API_BASE}/desktop/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'completed',
                        notes: notes,
                        completedCategories: ['A1', 'B1'], // Przyk≈Çadowe kategorie
                        photos: [] // Mo≈ºna dodaƒá obs≈Çugƒô zdjƒôƒá
                    })
                });
                
                if (response.ok) {
                    stopWorkTimer();
                    app.currentOrder = null;
                    refreshOrders();
                    alert('‚úÖ Zlecenie zosta≈Ço zako≈Ñczone!');
                    console.log('‚úÖ Zako≈Ñczono pracƒô nad zleceniem:', orderId);
                } else {
                    throw new Error('B≈ÇƒÖd serwera');
                }
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd ko≈Ñczenia pracy:', error);
                showError('Nie mo≈ºna zako≈Ñczyƒá pracy');
            }
        }
        
        // Timer pracy
        function startWorkTimer(orderTitle) {
            workStartTime = new Date();
            document.getElementById('currentOrderTitle').textContent = orderTitle;
            document.getElementById('workTimer').classList.remove('hidden');
            
            workTimer = setInterval(updateTimer, 1000);
        }
        
        function stopWorkTimer() {
            if (workTimer) {
                clearInterval(workTimer);
                workTimer = null;
                workStartTime = null;
                document.getElementById('workTimer').classList.add('hidden');
            }
        }
        
        function updateTimer() {
            if (!workStartTime) return;
            
            const now = new Date();
            const diff = now - workStartTime;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }
        
        // Od≈õwie≈ºenie zlece≈Ñ
        function refreshOrders() {
            loadOrders();
        }
        
        // Test po≈ÇƒÖczenia
        function testConnection() {
            checkConnection();
        }
        
        // Etykiety status√≥w
        function getStatusLabel(status) {
            const labels = {
                'new': 'Nowe',
                'in_progress': 'W trakcie',
                'completed': 'Zako≈Ñczone'
            };
            return labels[status] || status;
        }
        
        // Wy≈õwietlenie b≈Çƒôdu
        function showError(message) {
            const errorEl = document.createElement('div');
            errorEl.className = 'error';
            errorEl.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorEl, container.firstChild);
            
            setTimeout(() => {
                errorEl.remove();
            }, 5000);
        }
        
        // Automatyczna aktualizacja technik√≥w co 30 sekund
        let techniciansUpdateInterval = null;
        
        const startTechniciansAutoUpdate = () => {
            console.log('üîÑ Uruchamiam automatycznƒÖ aktualizacjƒô technik√≥w co 30 sekund');
            techniciansUpdateInterval = setInterval(async () => {
                try {
                    console.log('üîÑ Sprawdzam aktualizacje technik√≥w...');
                    const response = await fetch(`${API_BASE}/technicians`);
                    const updatedTechnicians = await response.json();
                    
                    // Sprawd≈∫ czy lista siƒô zmieni≈Ça
                    const currentTechnicians = Array.from(document.getElementById('techniciansList').children);
                    const currentIds = currentTechnicians.map(btn => {
                        const techId = btn.getAttribute('data-tech-id');
                        return techId ? parseInt(techId) : null;
                    }).filter(id => id !== null).sort();
                    
                    const newIds = updatedTechnicians.map(t => t.id).sort();
                    
                    if (JSON.stringify(currentIds) !== JSON.stringify(newIds)) {
                        console.log('üìã Wykryto zmiany w li≈õcie technik√≥w - aktualizujƒô...');
                        loadTechnicians();
                        
                        // Sprawd≈∫ czy aktualny technik nadal istnieje
                        if (currentTechnician && !updatedTechnicians.find(t => t.id === currentTechnician.id)) {
                            console.log('‚ö†Ô∏è Aktualny technik zosta≈Ç usuniƒôty - wracam do wyboru');
                            currentTechnician = null;
                            localStorage.removeItem('technicianId');
                            showTechnicianSelect();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå B≈ÇƒÖd automatycznej aktualizacji technik√≥w:', error);
                }
            }, 30000); // 30 sekund
        };
        
        const stopTechniciansAutoUpdate = () => {
            if (techniciansUpdateInterval) {
                console.log('üõë Zatrzymujƒô automatycznƒÖ aktualizacjƒô technik√≥w');
                clearInterval(techniciansUpdateInterval);
                techniciansUpdateInterval = null;
            }
        };
        
        // Automatyczne od≈õwie≈ºanie co 30 sekund
        setInterval(() => {
            if (currentTechnician && app.isConnected) {
                checkConnection();
                loadOrders();
            }
        }, 30000);
        
        // Uruchom automatycznƒÖ aktualizacjƒô technik√≥w przy starcie
        document.addEventListener('DOMContentLoaded', function() {
            startTechniciansAutoUpdate();
        });
        
        // Wymuszenie od≈õwie≈ºenia cache
        function forceRefresh() {
            console.log('üîÑ Wymuszanie od≈õwie≈ºenia cache...');
            
            // Usu≈Ñ stary Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for(let registration of registrations) {
                        registration.unregister();
                        console.log('üóëÔ∏è Stary SW usuniƒôty');
                    }
                });
            }
            
            // Wyczy≈õƒá localStorage
            localStorage.clear();
            console.log('üóëÔ∏è localStorage wyczyszczony');
            
            // Od≈õwie≈º stronƒô
            setTimeout(() => {
                window.location.reload(true);
            }, 1000);
        }
        
    </script>
</body>
</html> 