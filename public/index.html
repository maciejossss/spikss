<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Serwis Mobile</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob: http://localhost:5174 https://*; script-src 'self' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self' http://localhost:5174 https://*; font-src 'self' https://cdnjs.cloudflare.com data:;">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Serwis Mobile">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Vue.js Production (local fallback to avoid CSP issues) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js" integrity="" crossorigin="anonymous"></script>
  <!-- Usuniƒôto inline script (CSP). Fallback ≈Çadowany bezpo≈õrednio je≈õli brak Vue w oknie. -->
  <script src="/js/vue.global.prod.js" defer></script>

  <!-- pdfmake (UTF-8, polskie znaki) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.min.js"></script>
  
  <!-- API Configuration -->
  <script src="/js/config.js"></script>
  
  <style>
    /* Mobilny interfejs - du≈ºe klikowalne elementy */
    .mobile-tile {
      min-height: 80px;
      transition: all 0.2s ease;
    }
    .mobile-tile:active {
      transform: scale(0.95);
      background-color: #f3f4f6;
    }
    
    /* Prevent zoom on double tap */
    * {
      touch-action: manipulation;
    }
    
    /* Custom scrollbar for mobile */
    ::-webkit-scrollbar {
      width: 4px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app">
    <div v-if="initializing" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col items-center justify-center text-blue-900">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-6"></div>
      <h1 class="text-2xl font-semibold">Serwis Mobile</h1>
      <p class="text-sm opacity-80 mt-2">≈Åadowanie panelu technika...</p>
    </div>
    <!-- G≈Ç√≥wny kontener aplikacji -->
    <div v-else class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-tools text-2xl"></i>
            <div>
              <h1 class="text-xl font-bold">Serwis Mobile</h1>
              <p class="text-sm opacity-90">Zg≈Çoszenia serwisowe</p>
            </div>
          </div>
          <button v-if="showServiceForm && !formOnly"
                  @click="openTechnicianPanel"
                  class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
            <i class="fas fa-user-cog mr-2"></i>
            Panel technika
          </button>
          <button v-else
                  @click="openServiceForm"
                  class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
            <i class="fas fa-file-signature mr-2"></i>
            Formularz zg≈Çoszeniowy
          </button>
        </div>
      </div>

      <!-- Modal logowania serwisanta -->
      <div v-if="showLoginModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
          <h2 class="text-lg font-semibold mb-4">Logowanie serwisanta</h2>
          <div class="space-y-3">
            <input v-model="loginForm.username" class="w-full border rounded px-3 py-2" placeholder="Nazwa u≈ºytkownika" />
            <input v-model="loginForm.password" type="password" class="w-full border rounded px-3 py-2" placeholder="Has≈Ço" />
            <div class="flex justify-end gap-2 mt-2">
              <button @click="showLoginModal=false" class="px-3 py-2 border rounded">Anuluj</button>
              <button @click="doLogin" class="px-3 py-2 bg-blue-600 text-white rounded">Zaloguj</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal PIN logowania (preferowany) -->
      <div v-if="showPinModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
          <h2 class="text-lg font-semibold mb-4">Logowanie PIN</h2>
          <p class="text-sm text-gray-600 mb-2" v-if="pinTarget && pinTarget.name">Technik: <strong>{{ pinTarget.name }}</strong></p>
          <input v-model="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="8" class="w-full border rounded px-3 py-2 tracking-widest text-center" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <div class="flex justify-end gap-2 mt-3">
            <button @click="showPinModal=false; pinInput=''; pinTarget=null;" class="px-3 py-2 border rounded">Anuluj</button>
            <button @click="submitPin" class="px-3 py-2 bg-blue-600 text-white rounded">Zaloguj</button>
          </div>
        </div>
      </div>

      <!-- Formularz zg≈Çoszenia serwisowego -->
      <div v-if="showServiceForm" class="p-4">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
            üõ†Ô∏è Formularz zg≈Çoszenia serwisowego
          </h2>
          <div v-if="!formOnly" class="flex justify-end mb-4">
            <button @click="openTechnicianPanel"
                    class="text-sm text-blue-600 hover:text-blue-800 font-semibold">
              <i class="fas fa-arrow-left mr-1"></i>
              Wr√≥ƒá do panelu technika
            </button>
          </div>
          
          <form @submit.prevent="submitServiceRequest" class="space-y-4">
            <!-- Typ zg≈Çoszenia (radiobuttony) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Typ zg≈Çoszenia *</label>
              <div class="space-y-2">
                <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                  <input type="radio" class="mr-3" value="awaria" v-model="form.serviceType" required>
                  <span>üö® Awaria (pilne)</span>
                </label>
                <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                  <input type="radio" class="mr-3" value="przeglad" v-model="form.serviceType">
                  <span>üõ†Ô∏è PrzeglƒÖd okresowy</span>
                </label>
                <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                  <input type="radio" class="mr-3" value="doradztwo" v-model="form.serviceType">
                  <span>üí° Pytanie techniczne / doradztwo</span>
                </label>
                <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                  <input type="radio" class="mr-3" value="inne" v-model="form.serviceType">
                  <span>üìÑ Inne</span>
                </label>
              </div>
            </div>

            <!-- Dane kontaktowe -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Imiƒô i nazwisko *</label>
                <input v-model="form.contactName" type="text" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Jan Kowalski">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Telefon *</label>
                <input v-model="form.phone" type="tel" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="123-456-789">
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
              <input v-model="form.email" type="email" required
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                     placeholder="jan@example.com">
            </div>

            <!-- NIP (opcjonalny) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">NIP (opcjonalny)</label>
              <input v-model="form.nip" type="text"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                     placeholder="123-456-78-90">
            </div>

            <!-- Lokalizacja urzƒÖdzenia -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ulica, numer budynku *</label>
                <input v-model="form.street" type="text" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="np. ul. Przyk≈Çadowa 1">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Kod pocztowy, miejscowo≈õƒá *</label>
                <input v-model="form.postalCity" type="text" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="00-000 Warszawa">
              </div>
            </div>

            <!-- Dojazd -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Instrukcje dojazdu</label>
              <textarea v-model="form.directions" rows="2"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Opis jak dojechaƒá..."></textarea>
            </div>

            <!-- Dane techniczne urzƒÖdzenia -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Typ urzƒÖdzenia *</label>
                <select v-model="form.deviceType" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">Wybierz typ</option>
                  <option value="kociol_gazowy">Kocio≈Ç gazowy</option>
                  <option value="palnik_olejowy">Palnik olejowy</option>
                  <option value="pompa_ciepla">Pompa ciep≈Ça</option>
                  <option value="inne">Inne</option>
                </select>
                <div v-if="form.deviceType === 'inne'" class="mt-2">
                  <input v-model="form.deviceTypeOther" type="text"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                         placeholder="Podaj typ urzƒÖdzenia">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Marka i model</label>
                <input v-model="form.deviceModel" type="text"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="np. Viessmann Vitodens 200">
              </div>
              
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Czy jeste≈õ naszym klientem?</label>
              <select v-model="form.deviceServiced" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Wybierz</option>
                <option value="tak">Tak</option>
                <option value="nie">Nie</option>
              </select>
            </div>

            <!-- Poprzedni serwis -->
            

            <!-- Opis problemu -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Opis problemu/us≈Çugi</label>
              <textarea v-model="form.description" rows="4"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Uzupe≈Çnij: je≈õli na urzƒÖdzeniu wy≈õwietla siƒô b≈ÇƒÖd, podaj jaki"></textarea>
            </div>

            <!-- Preferowany termin -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Preferowana data</label>
                <input v-model="form.preferredDate" type="date"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Preferowana godzina</label>
                <input v-model="form.preferredTime" type="time"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>

            <!-- Priorytet -->
            <div class="flex items-center space-x-4">
              <label class="flex items-center">
                <input v-model="form.isUrgent" type="checkbox"
                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <span class="ml-2 text-sm font-medium text-gray-700">üö® Pilne</span>
              </label>
            </div>

            <!-- Zgody -->
            <div class="space-y-2">
              <label class="flex items-center">
                <input v-model="form.privacyPolicy" type="checkbox" required
                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">* Zgadzam siƒô z politykƒÖ prywatno≈õci</span>
              </label>
              <label class="flex items-center">
                <input v-model="form.emailCopy" type="checkbox"
                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Wy≈õlij kopiƒô na email</span>
              </label>
            </div>

            

            <!-- Przycisk wys≈Çania -->
            <button type="submit" :disabled="!canSubmit || submitting"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-4 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 disabled:transform-none">
              <span v-if="submitting">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                Wysy≈Çanie...
              </span>
              <span v-else>
                <i class="fas fa-paper-plane mr-2"></i>
                Wy≈õlij zg≈Çoszenie
              </span>
            </button>
          </form>
        </div>
      </div>

      <!-- Panel technika -->
      <div v-if="!formOnly && isTechnicianPanelVisible && !showServiceForm" class="p-4">
        <!-- Header panelu -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-800">
              <i class="fas fa-user-cog mr-2"></i>
              Panel technika
            </h2>
            <button @click="openServiceForm"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
              <i class="fas fa-file-signature mr-2"></i>
              Formularz zg≈Çoszeniowy
            </button>
          </div>
        </div>

        <!-- Lista technik√≥w -->
        <div v-if="currentView === 'technicians'" class="space-y-3">
          <div v-for="(technician, index) in technicians" :key="technician.id || index"
               @click="selectTechnician(technician)"
               class="bg-white rounded-lg shadow-md p-4 cursor-pointer hover:shadow-lg transition-all">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                <span class="text-blue-600 font-bold text-lg">{{ (technician.name || 'T').charAt(0).toUpperCase() }}</span>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900">{{ technician.name || 'Brak nazwy' }}</h3>
                <p class="text-sm text-gray-600">{{ technician.phone || 'Brak telefonu' }}</p>
                <p class="text-xs text-gray-500">Zlece≈Ñ: {{ technician.order_count ?? getTechnicianOrderCount(technician.id) }}</p>
              </div>
              <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
          </div>
        </div>

        <!-- Lista zlece≈Ñ -->
        <div v-if="currentView === 'orders'" class="space-y-3">
          <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-gray-900">
                <i class="fas fa-list mr-2"></i>
                Zlecenia dla: {{ selectedTechnician?.name || 'Brak nazwy' }}
              </h3>
              <div class="space-x-2">
                <button @click="openCalendar"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                  <i class="fas fa-calendar-alt mr-1"></i>
                  Kalendarz
                </button>
                <button @click="backToTechnicians"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-colors">
                  <i class="fas fa-arrow-left mr-1"></i>
                  Wstecz
                </button>
              </div>
            </div>
          </div>

          <div v-for="(order, index) in orders" :key="order.id || index"
               @click="selectOrder(order)"
               class="bg-white rounded-lg shadow-md p-4 cursor-pointer hover:shadow-lg transition-all">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h4 class="font-semibold text-gray-900">{{ order.order_number || 'Brak numeru' }}</h4>
                <p v-if="order.title" class="text-sm text-gray-700 mt-0.5">{{ order.title }}</p>
                <p class="text-sm text-gray-600">{{ order.client_name || 'Brak nazwy klienta' }}</p>
                <p class="text-sm text-gray-600">{{ order.address || 'Brak adresu' }}</p>
                <div class="flex items-center space-x-2 mt-2">
                  <span :class="getStatusColor(order.status)" class="px-2 py-1 rounded-full text-xs font-medium">
                    {{ getStatusText(order.status) }}
                  </span>
                  <span :class="getPriorityColor(order.priority)" class="px-2 py-1 rounded-full text-xs font-medium">
                    {{ order.priority || 'medium' }}
                  </span>
                  <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800" v-if="order.scheduled_datetime || order.scheduled_date">
                    <i class="far fa-clock mr-1"></i>{{ formatDateTimeLocal(order.scheduled_datetime || order.scheduled_date) }}
                  </span>
                  <span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800" v-if="order._paused">
                    ‚è∏Ô∏è Zawieszone
                  </span>
                </div>
              </div>
              <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
          </div>
        </div>

        <!-- Szczeg√≥≈Çy zlecenia -->
        <div v-if="currentView === 'order-details'" class="space-y-3">
          <div v-if="companyProfile" class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-semibold text-gray-900 flex items-center">
              <i class="fas fa-building mr-2 text-blue-600"></i>
              Dane serwisu
            </h3>
            <div class="mt-3 space-y-1 text-sm text-gray-700">
              <p class="font-medium text-gray-900" v-if="companyProfile.name">{{ companyProfile.name }}</p>
              <p v-if="companyProfile.address">{{ companyProfile.address }}</p>
              <p v-if="companyProfile.nip">NIP: {{ companyProfile.nip }}</p>
              <p v-if="companyProfile.regon">REGON: {{ companyProfile.regon }}</p>
              <p v-if="companyProfile.phone">Telefon: {{ companyProfile.phone }}</p>
              <p v-if="companyProfile.email">Email: {{ companyProfile.email }}</p>
              <p v-if="companyProfile.website">
                Strona: <a :href="companyProfile.website" target="_blank" rel="noopener" class="text-blue-600 hover:underline">{{ companyProfile.website }}</a>
              </p>
            </div>
          </div>
          <div v-else class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 class="font-semibold text-gray-900 flex items-center">
              <i class="fas fa-building mr-2 text-blue-600"></i>
              Dane serwisu
            </h3>
            <p class="mt-3 text-sm text-gray-500">Brak zdefiniowanych danych serwisu.</p>
          </div>

          <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-gray-900">
                <i class="fas fa-file-alt mr-2"></i>
                Szczeg√≥≈Çy zlecenia
              </h3>
              <button @click="backToOrders"
                      class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-colors">
                <i class="fas fa-arrow-left mr-1"></i>
                Wstecz
              </button>
            </div>
          </div>

          <div v-if="selectedOrder" class="bg-white rounded-lg shadow-md p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Dane klienta -->
              <div class="md:col-span-2 bg-blue-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-3">üë§ Dane klienta</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <span class="text-sm font-medium text-gray-600">Nazwa:</span>
                    <p class="text-gray-800">{{ selectedOrder.client_name || 'Brak nazwy' }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Telefon:</span>
                    <p class="text-gray-800">{{ selectedOrder.client_phone || 'Brak telefonu' }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Email:</span>
                    <p class="text-gray-800">{{ selectedOrder.client_email || 'Brak email' }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Adres:</span>
                    <p class="text-gray-800">
                      <a v-if="selectedOrder.address" :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(selectedOrder.address)}`" target="_blank" rel="noopener" class="text-blue-600 hover:underline">
                        {{ selectedOrder.address }}
                      </a>
                      <span v-else>Brak adresu</span>
                    </p>
                  </div>
                </div>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button @click="openInMaps(selectedOrder.address)" :disabled="!selectedOrder.address" class="bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded hover:bg-blue-50 disabled:opacity-50">
                    üìç Otw√≥rz w Google Maps
                  </button>
                  <button @click="openEditClient" class="bg-white border border-indigo-200 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-50">
                    ‚úèÔ∏è Edytuj dane klienta
                  </button>
                </div>
              </div>

              <!-- Dane urzƒÖdzenia -->
              <div class="md:col-span-2 bg-green-50 p-4 rounded-lg">
                <h3 class="font-semibold text-green-800 mb-3">üîß Dane urzƒÖdzenia</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <span class="text-sm font-medium text-gray-600">Nazwa:</span>
                    <p class="text-gray-800">{{ selectedOrder.device_name || 'Brak urzƒÖdzenia' }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Marka:</span>
                    <p class="text-gray-800">{{ selectedOrder.device_brand || 'Brak marki' }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Model:</span>
                    <p class="text-gray-800">{{ selectedOrder.device_model || 'Brak modelu' }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Numer seryjny:</span>
                    <p class="text-gray-800">{{ selectedOrder.device_serial || 'Brak numeru seryjnego' }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Typ paliwa:</span>
                    <p class="text-gray-800">{{ selectedOrder.device_fuel_type || 'Brak danych' }}</p>
                  </div>
                </div>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button v-if="selectedOrder.device_id" @click="openEditDevice" class="bg-white border border-green-200 text-green-700 px-3 py-1 rounded hover:bg-green-50">
                    ‚úèÔ∏è Edytuj dane urzƒÖdzenia
                  </button>
                  <button v-else @click="openAttachDevice" class="bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded hover:bg-blue-50">
                    üîó Przypisz urzƒÖdzenie
                  </button>
                </div>
              </div>

              <!-- Status i priorytet -->
              <div>
                <h3 class="font-semibold text-gray-800">Status</h3>
                <span :class="getStatusColor(selectedOrder.status)" class="px-3 py-1 rounded-full text-sm font-medium">
                  {{ getStatusText(selectedOrder.status) }}
                </span>
              </div>
              
              <div>
                <h3 class="font-semibold text-gray-800">Priorytet</h3>
                <span :class="getPriorityColor(selectedOrder.priority)" class="px-3 py-1 rounded-full text-sm font-medium">
                  {{ selectedOrder.priority || 'medium' }}
                </span>
              </div>
              
              <!-- Opis -->
              <div class="md:col-span-2">
                <h3 class="font-semibold text-gray-800">Opis problemu</h3>
                <p class="text-gray-600">{{ selectedOrder.description || 'Brak opisu' }}</p>
              </div>
              
              <!-- Termin -->
              <div>
                <h3 class="font-semibold text-gray-800">Data zaplanowana</h3>
                <p class="text-gray-600">{{ formatDateTimeLocal(selectedOrder.scheduled_datetime || selectedOrder.scheduled_date) }}</p>
              </div>
              
              <!-- Koszt -->
              <div>
                <h3 class="font-semibold text-gray-800">Szacowany koszt</h3>
                <template v-if="selectedOrder.estimated_cost_note">
                  <div class="p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-900 whitespace-pre-wrap">
                    {{ selectedOrder.estimated_cost_note }}
                  </div>
                </template>
                <template v-else-if="selectedOrder.estimated_cost_display">
                  <div class="p-2 text-gray-700">{{ selectedOrder.estimated_cost_display }}</div>
                </template>
                <template v-else>
                  <template v-if="Number(selectedOrder.total_cost||0) > 0">
                    <p class="text-gray-600">{{ (Number(selectedOrder.total_cost||0)).toFixed(2) }} z≈Ç</p>
                  </template>
                  <template v-else>
                    <button @click="refreshSelectedOrderFromRailway" :disabled="selectedOrder._loading" class="text-sm px-3 py-1 rounded border bg-white hover:bg-gray-50 disabled:opacity-60">
                      {{ selectedOrder._justUpdated ? 'Zaktualizowano koszt ‚Äî od≈õwie≈º' : 'Nie ustalono ‚Äî sprawd≈∫ teraz' }}
                    </button>
                  </template>
                </template>
                <div v-if="selectedOrder._justUpdated" class="mt-2 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-2 py-1 inline-block">
                  Zaktualizowano koszt us≈Çugi
                </div>
              </div>

              <!-- Czas pracy (raport) -->
              <div class="md:col-span-2 bg-gray-50 p-4 rounded-lg" v-if="selectedOrder.status==='completed'">
                <h3 class="font-semibold text-gray-800 mb-2">‚è±Ô∏è Czas pracy</h3>
                <div class="text-sm text-gray-700">
                  <div v-if="timeSummaryLoading">≈Åadowanie raportu...</div>
                  <div v-else-if="timeSummaryError" class="text-red-600">{{ timeSummaryError }}</div>
                  <div v-else-if="timeSummary">
                    <div>Rozpoczƒôto: <strong>{{ formatDateTimeLocal(timeSummary.firstStart) }}</strong></div>
                    <div>Zako≈Ñczono: <strong>{{ formatDateTimeLocal(timeSummary.lastEnd) }}</strong></div>
                    <div class="mt-1">Pauzy: <strong>{{ timeSummary.pause_count }}</strong> (≈ÇƒÖcznie {{ Math.round(timeSummary.pause_seconds/60) }} min)</div>
                    <div class="mt-1">≈ÅƒÖcznie czasu pracy: <strong>{{ timeSummary.worked_hours.toFixed(1) }} h</strong> ({{ Math.round(timeSummary.total_seconds/60) }} min)</div>
                  </div>
                  <div v-else class="text-gray-500">Brak danych o czasie pracy</div>
                </div>
              </div>

              <!-- Informacje serwisowe -->
              <div class="md:col-span-2 bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-gray-800 mb-3">üßæ Informacje serwisowe</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <span class="text-sm font-medium text-gray-600">Data instalacji</span>
                    <p class="text-gray-800">{{ formatDateLocal(selectedOrder.device_installation_date) }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Koniec gwarancji</span>
                    <p class="text-gray-800">{{ formatDateLocal(selectedOrder.device_warranty_end_date) }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Ostatni serwis</span>
                    <p class="text-gray-800">{{ formatDateLocal(selectedOrder.device_last_service_date) }}</p>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-gray-600">Nastƒôpny serwis</span>
                    <p class="text-gray-800">{{ formatDateLocal(selectedOrder.device_next_service_date) }}</p>
                  </div>
                </div>
              </div>

              <!-- Czƒô≈õci i zdjƒôcia -->
              <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border rounded p-3">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold">U≈ºyte czƒô≈õci</h4>
                    <button @click="exportPartsTimelinePdf()" :disabled="!devicePartsTimeline || devicePartsTimeline.length===0" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded disabled:opacity-50">
                      Pobierz PDF
                    </button>
                  </div>
                  <div v-if="devicePartsTimeline && devicePartsTimeline.length" class="space-y-1">
                    <div v-for="(it, i) in devicePartsTimeline" :key="i" class="text-sm text-gray-800">
                      <div class="flex items-center justify-between">
                        <span class="text-gray-600">{{ formatDateTimeLocal(it.date) }}</span>
                        <span class="text-gray-700 font-medium">{{ it.order_number }}</span>
                      </div>
                      <div class="text-gray-900 whitespace-pre-wrap">{{ it.parts_used }}</div>
                      <div class="h-px bg-gray-100 my-1" v-if="i < devicePartsTimeline.length-1"></div>
                    </div>
                  </div>
                  <div v-else class="text-sm text-gray-600">Brak danych</div>
                </div>
                <div class="bg-white border rounded p-3">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold">Dokumentacja zdjƒôciowa klienta</h4>
                    <div class="space-x-2">
                      <button @click="fetchDevicePhotosForOrder(selectedOrder)" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Od≈õwie≈º zdjƒôcia</button>
                      <button @click="fetchDeviceDocsForOrder(selectedOrder)" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Od≈õwie≈º dokumenty</button>
                    </div>
                  </div>
                  <div v-if="getWorkPhotos(selectedOrder.work_photos).length" class="grid grid-cols-3 gap-2 mb-3">
                    <div v-for="(ph, i) in getWorkPhotos(selectedOrder.work_photos)" :key="i" class="relative group">
                      <img :src="resolvePhotoSrc(ph)" loading="lazy" @click.stop="openPhotoViewer(i)" class="w-full h-20 object-cover rounded cursor-pointer hover:opacity-90" />
                      <button @click.stop="deletePhoto(ph)" class="hidden group-hover:block absolute top-1 right-1 bg-white/80 hover:bg-white text-red-600 rounded p-1" title="Usu≈Ñ">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div v-else class="text-sm text-gray-600 mb-3">Brak zdjƒôƒá</div>
                  <div>
                    <h5 class="font-semibold mb-2">Dokumenty (PDF)</h5>
                    <div v-if="selectedOrderDocuments && selectedOrderDocuments.length" class="space-y-2">
                      <div v-for="(doc, di) in selectedOrderDocuments" :key="doc.id || di" class="flex items-center justify-between bg-gray-50 rounded px-3 py-2">
                        <div class="flex items-center gap-2 truncate">
                          <i class="fas fa-file-pdf text-red-600"></i>
                          <span class="truncate">{{ doc.name }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <button @click="openDocument(doc)" class="text-sm px-2 py-1 bg-white border rounded hover:bg-gray-100">Otw√≥rz</button>
                          <button @click="downloadDocument(doc)" class="text-sm px-2 py-1 bg-white border rounded hover:bg-gray-100">Pobierz</button>
                          <button v-if="doc.id" @click="deleteDocument(doc)" class="text-sm px-2 py-1 bg-white border rounded text-red-600 hover:bg-red-50">Usu≈Ñ</button>
                        </div>
                      </div>
                    </div>
                    <div v-else class="text-sm text-gray-600">Brak dokument√≥w</div>
                  </div>
                </div>
              </div>

              <!-- Historia urzƒÖdzenia (ostatnie zlecenia dla tego urzƒÖdzenia) -->
              <div class="md:col-span-2 bg-white border rounded p-3">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-semibold">Historia urzƒÖdzenia</h4>
                  <div class="space-x-2">
                    <button @click="loadDeviceHistory()" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Od≈õwie≈º historiƒô</button>
                    <button @click="toggleHistory()" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">
                      {{ showAllHistory ? 'Zwi≈Ñ' : 'Poka≈º ca≈ÇƒÖ' }}
                    </button>
                  </div>
                </div>
                <div v-if="deviceHistory && deviceHistory.length" class="space-y-2">
                  <div v-for="(h, idx) in (showAllHistory ? deviceHistory : deviceHistory.slice(0,1))" :key="h.id || idx" class="p-2 border rounded cursor-pointer hover:bg-gray-50" @click="openHistoryDetail(h)">
                    <div class="flex items-center justify-between text-sm">
                      <div class="font-medium truncate">{{ h.order_number || ('Z-' + h.id) }}</div>
                      <div>
                        <span class="px-2 py-0.5 rounded text-xs bg-gray-100">{{ h.status }}</span>
                      </div>
                    </div>
                    <div class="text-sm text-gray-700 mt-1 truncate">{{ h.title || h.description }}</div>
                    <div class="text-xs text-gray-500 mt-1">{{ h.completed_at || h.started_at || h.scheduled_date || h.created_at }}</div>
                    <div v-if="h.parts_used" class="text-xs text-gray-600 mt-1">Czƒô≈õci: {{ h.parts_used }}</div>
                  </div>
                </div>
                <div v-else class="text-sm text-gray-600">Brak historii dla tego urzƒÖdzenia</div>
              </div>

              <!-- Modal szczeg√≥≈Çy historii (PWA) -->
              <div v-if="showHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="closeHistoryDetail()">
                <div class="bg-white rounded-lg shadow-lg w-full max-w-lg m-3">
                  <div class="p-4 border-b flex items-center justify-between sticky top-0 bg-white rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-900">Szczeg√≥≈Çy serwisu</h3>
                    <button @click="closeHistoryDetail()" class="text-gray-500 hover:text-gray-800">‚úï</button>
                  </div>
                  <div v-if="selectedHistory" class="p-4 max-h-[70vh] overflow-y-auto">
                    <div class="text-sm text-gray-700 break-words">
                      <div class="font-medium text-gray-900">{{ selectedHistory.order_number }} ‚Äî {{ selectedHistory.title }}</div>
                      <div class="text-xs text-gray-500 mb-2">{{ (selectedHistory.completed_at || selectedHistory.created_at) }}</div>
                      <div v-if="parsedHistoryCategories(selectedHistory).length" class="mb-2">
                        <div class="text-xs text-gray-500 mb-1">Wykonane czynno≈õci:</div>
                        <ul class="list-disc list-inside">
                          <li v-for="c in parsedHistoryCategories(selectedHistory)" :key="c" class="text-sm">{{ c }}</li>
                        </ul>
                      </div>
                      <div v-if="selectedHistory.completion_notes" class="mb-2">
                        <div class="text-xs text-gray-500 mb-1">Notatki:</div>
                        <div class="whitespace-pre-wrap text-sm">{{ selectedHistory.completion_notes }}</div>
                      </div>
                      <div v-if="selectedHistory.work_photos && (Array.isArray(selectedHistory.work_photos) ? selectedHistory.work_photos.length : String(selectedHistory.work_photos||'').length)" class="mt-2">
                        <div class="text-xs text-gray-500 mb-1">Zdjƒôcia:</div>
                        <div class="grid grid-cols-3 gap-2">
                          <img v-for="(ph, i) in (Array.isArray(selectedHistory.work_photos) ? selectedHistory.work_photos : [])" :key="i" :src="resolveHistoryPhotoSrc(ph)" class="w-full h-20 object-cover rounded" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Przyciski: rozpocznij / pauza / zako≈Ñcz -->
              <div class="md:col-span-2 grid grid-cols-3 gap-3" v-if="selectedOrder.status !== 'completed'">
                <button @click="startSelectedOrder" 
                        :class="['w-full text-white font-bold py-3 px-6 rounded-lg transition-colors', (selectedOrder.status==='in_progress' ? 'bg-blue-700' : 'bg-blue-600 hover:bg-blue-700')]">
                  {{ selectedOrder.status==='in_progress' ? '‚ñ∂Ô∏è W realizacji' : '‚ñ∂Ô∏è Rozpocznij' }}
                </button>
                <button @click="togglePauseSelectedOrder" 
                        :class="['w-full font-bold py-3 px-6 rounded-lg transition-colors', (selectedOrder._paused ? 'bg-red-100 text-red-800 border border-red-300' : 'bg-gray-100 text-gray-800 hover:bg-gray-200')]">
                  {{ selectedOrder._paused ? '‚è∏Ô∏è Zawieszone ‚Äî Wzn√≥w' : '‚è∏Ô∏è Pauza' }}
                </button>
                <button @click="showCompletionModal" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                  ‚úÖ Zako≈Ñcz zlecenie
                </button>
              </div>
              <!-- Przyciski po zako≈Ñczeniu -->
              <div class="md:col-span-2 flex space-x-3" v-else>
                <button @click="checkAndDeleteOrder" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                  üóëÔ∏è Usu≈Ñ zlecenie
                </button>
                <button @click="sendToDesktop" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                  üì§ Wy≈õlij do firmy
                </button>
              </div>
              <div class="md:col-span-2 text-sm text-gray-600" v-if="selectedOrder.status === 'completed'">
                <span v-if="selectedOrder.desktop_sync_status === 'imported'" class="text-green-700">Status: odebrane przez firmƒô ({{ selectedOrder.desktop_synced_at || '' }})</span>
                 <span v-else-if="selectedOrder.desktop_sync_status === 'sent'" class="text-blue-700">Status: wys≈Çano do firmy ({{ selectedOrder.desktop_synced_at || '' }})</span>
                 <span v-else class="text-yellow-700">Status: nie wys≈Çano</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Kalendarz technika -->
        <div v-if="currentView === 'calendar'" class="space-y-3">
          <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-gray-900">
                <i class="fas fa-calendar-alt mr-2"></i>
                Kalendarz: {{ selectedTechnician?.name || '' }}
              </h3>
              <div class="space-x-2">
                <button @click="prevCalMonth" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                <span class="text-sm font-medium">{{ formatCalMonthYear(currentCalendarDate) }}</span>
                <button @click="nextCalMonth" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                <button @click="backToOrders" class="ml-3 bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">Wr√≥ƒá</button>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-3">
            <div class="grid grid-cols-7 border-b">
              <div v-for="d in calendarWeekDays" :key="d" class="p-2 text-center text-xs font-semibold text-gray-600">{{ d }}</div>
            </div>
            <div class="grid grid-cols-7">
              <div v-for="day in calendarDays" :key="day.key" class="border-r border-b min-h-[110px] p-2" :class="{ 'bg-gray-50': !day.inMonth }">
                <div class="text-xs font-medium" :class="day.isToday ? 'text-blue-600' : 'text-gray-700'">{{ day.day }}</div>
                <div class="mt-1 space-y-1">
                  <button v-for="(ev, idx) in day.events.slice(0,3)" :key="idx" @click="openCalendarEvent(ev)" class="w-full text-left text-[10px] px-1 py-0.5 rounded bg-blue-100 text-blue-800 truncate hover:bg-blue-200">
                    <span v-if="ev.time" class="font-semibold mr-1">{{ ev.time }}</span>{{ ev.title }}
                  </button>
                  <div v-if="day.events.length>3" class="text-[10px] text-gray-500">+{{ day.events.length-3 }} wiƒôcej</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
  <!-- Modal zako≈Ñczenia zlecenia -->
  <div v-if="isCompletionModalVisible" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">‚úÖ Zako≈Ñcz zlecenie</h3>
        <button @click="hideCompletionModal" class="text-gray-500 hover:text-gray-700">
          <span class="text-2xl">√ó</span>
        </button>
      </div>
      
      <form @submit.prevent="completeOrder" class="space-y-4">
        <!-- Kategoria g≈Ç√≥wna -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Kategoria g≈Ç√≥wna *</label>
          <select v-model="completionData.mainCategory" required @change="onMainCategoryChange"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Wybierz kategoriƒô</option>
            <option v-for="(category, key) in serviceCategories" :key="key" :value="key">
              {{ category.name }}
            </option>
          </select>
        </div>

        <!-- Podkategoria -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Podkategorie *</label>
          <div class="space-y-2">
            <p class="text-xs text-gray-500">Mo≈ºesz zaznaczyƒá jednƒÖ lub kilka czynno≈õci wykonywanych w ramach zlecenia.</p>
            <div v-if="availableSubCategories.length === 0" class="text-sm text-gray-500">
              Najpierw wybierz kategoriƒô g≈Ç√≥wnƒÖ, aby zobaczyƒá listƒô czynno≈õci.
            </div>
            <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <button
                type="button"
                v-for="item in availableSubCategories"
                :key="item.code"
                @click="toggleSubCategory(item.code)"
                class="flex items-start justify-between p-3 border rounded-lg text-left transition-colors"
                :class="completionData.selectedSubCategories.includes(item.code) ? 'border-green-400 bg-green-50' : 'border-gray-200 bg-white hover:bg-gray-50'"
              >
                <span class="flex-1 pr-3">
                  <span class="font-medium text-gray-900 block">{{ item.label }}</span>
                  <span class="text-xs text-gray-500">{{ item.code }}</span>
                </span>
                <i
                  :class="completionData.selectedSubCategories.includes(item.code) ? 'fas fa-check text-green-600 mt-1' : 'far fa-circle text-gray-400 mt-1'"
                ></i>
              </button>
            </div>
            <div v-if="completionData.selectedSubCategories.length" class="text-xs text-gray-500">
              Wybrane: {{ completionData.selectedSubCategories.length }}
            </div>
          </div>
        </div>

        <!-- Opis wykonanej pracy -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Opis wykonanej pracy *</label>
          <textarea v-model="completionData.workDescription" required rows="4"
                    @input="onWorkDescriptionInput"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Opisz szczeg√≥≈Çowo co zosta≈Ço wykonane..."></textarea>
        </div>

        <!-- Zdjƒôcia (opcjonalnie) ‚Äì WY≈ÅƒÑCZONE -->

        <!-- U≈ºyte czƒô≈õci (ukryte ‚Äì zarzƒÖdza operator na desktopie) -->
        <div v-if="false">
          <label class="block text-sm font-medium text-gray-700 mb-2">U≈ºyte czƒô≈õci</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Kategoria czƒô≈õci</label>
              <select v-model="partMainCatId" @change="onPartMainCatChange" class="w-full px-3 py-2 border rounded-lg">
                <option :value="null">(wszystkie)</option>
                <option v-for="cat in partMainCategories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Podkategoria czƒô≈õci</label>
              <select v-model="partSubCatId" :disabled="!partMainCatId || partSubCategories.length===0" class="w-full px-3 py-2 border rounded-lg">
                <option :value="null">(wszystkie)</option>
                <option v-for="cat in partSubCategories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
              </select>
            </div>
          </div>
          <div class="mb-2">
            <select multiple v-model="completionData.selectedParts" @change="onSelectedPartsChange" class="w-full px-3 py-2 border rounded-lg">
              <option v-for="p in filteredPartsCatalog" :key="p.id" :value="p.sku ? (p.name + ' ('+p.sku+')') : p.name">{{ p.name }}{{ p.sku ? ' ('+p.sku+')' : '' }}</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Mo≈ºesz wybraƒá wiele pozycji. Je≈õli lista jest pusta, u≈ºyj pola tekstowego poni≈ºej.</p>
          </div>
          <textarea v-model="completionData.partsUsed" @input="onPartsUsedInput" rows="2"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Lista u≈ºytych czƒô≈õci..."></textarea>
        </div>

        <!-- Godziny pracy -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Godziny pracy</label>
            <input v-model="completionData.hoursWorked" type="number" step="0.5"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   placeholder="np. 2.5">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Data wykonania</label>
            <input v-model="completionData.completionDate" type="date" @change="onCompletionDateChange"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>

        <!-- Uwagi -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Uwagi</label>
          <textarea v-model="completionData.notes" rows="3"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Dodatkowe uwagi..."></textarea>
        </div>

        <!-- Przyciski -->
        <div class="flex space-x-3 pt-4">
          <button type="button" @click="hideCompletionModal" 
                  class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium transition-colors">
            Anuluj
          </button>
          <button type="submit" :disabled="!canCompleteOrder"
                  class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white py-3 px-4 rounded-lg font-medium transition-colors">
            ‚úÖ Zako≈Ñcz zlecenie
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal edycji klienta -->
  <div v-if="showEditClientModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Edytuj dane klienta</h3>
        <button @click="closeEditClient" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Telefon</label>
          <input v-model="editClient.phone" type="tel" class="w-full px-3 py-2 border rounded" placeholder="np. 555 123 456" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Email</label>
          <input v-model="editClient.email" type="email" class="w-full px-3 py-2 border rounded" placeholder="np. klient@example.com" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Adres</label>
          <input v-model="editClient.address" type="text" class="w-full px-3 py-2 border rounded" placeholder="Ulica, miasto, kod" />
        </div>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button @click="closeEditClient" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Anuluj</button>
        <button @click="updateClient(editClient)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Zapisz</button>
      </div>
    </div>
  </div>

  <!-- Modal edycji urzƒÖdzenia -->
  <div v-if="showEditDeviceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Edytuj dane urzƒÖdzenia</h3>
        <button @click="closeEditDevice" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Marka</label>
          <input v-model="editDevice.manufacturer" type="text" class="w-full px-3 py-2 border rounded" placeholder="np. BOSCH" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Numer seryjny</label>
          <input v-model="editDevice.serial_number" type="text" class="w-full px-3 py-2 border rounded" placeholder="np. SN123..." />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Typ paliwa</label>
          <input v-model="editDevice.fuel_type" type="text" class="w-full px-3 py-2 border rounded" placeholder="np. Gaz ziemny" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Data instalacji</label>
            <input v-model="editDevice.installation_date" type="date" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Koniec gwarancji</label>
            <input v-model="editDevice.warranty_end_date" type="date" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Ostatni serwis</label>
            <input v-model="editDevice.last_service_date" type="date" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Nastƒôpny serwis</label>
            <input v-model="editDevice.next_service_date" type="date" class="w-full px-3 py-2 border rounded" />
          </div>
        </div>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button @click="closeEditDevice" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Anuluj</button>
        <button @click="saveDeviceEdits" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Zapisz</button>
      </div>
    </div>
  </div>

  <!-- Modal przypiƒôcia urzƒÖdzenia -->
  <div v-if="showAttachDeviceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Przypisz urzƒÖdzenie klienta</h3>
        <button @click="closeAttachDevice" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">UrzƒÖdzenie</label>
        <select v-model="attachDeviceId" class="w-full border rounded px-3 py-2">
          <option :value="null">‚Äî wybierz ‚Äî</option>
          <option v-for="d in clientDevices" :key="d.id" :value="d.id">{{ d.name }} ‚Äî {{ d.brand || 'Brak marki' }} {{ d.model || '' }}</option>
        </select>
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button @click="closeAttachDevice" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Anuluj</button>
        <button @click="saveAttachDevice" :disabled="!attachDeviceId" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Zapisz</button>
      </div>
    </div>
  </div>

  <!-- Modal sukcesu -->
  <div v-if="showSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click="hideSuccessModal">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 relative" @click.stop>
      <!-- Przycisk X w rogu -->
      <button @click="hideSuccessModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-xl font-bold">
        √ó
      </button>
      
      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-check text-green-600 text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Sukces!</h3>
        <p class="text-gray-600 mb-4">Zg≈Çoszenie zosta≈Ço wys≈Çane pomy≈õlnie</p>
        <p class="text-sm text-gray-500 mb-4">Numer referencyjny: <strong>{{ referenceNumber }}</strong></p>
        <div class="flex space-x-3">
          <button @click="hideSuccessModal" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
            OK
          </button>
          <button @click="hideSuccessModal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
            Zamknij
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Photo Viewer Modal -->
  <div v-if="showPhotoModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center" @click="closePhotoViewer">
    <div class="relative max-w-5xl w-full mx-4" @click.stop>
      <img :src="photoModalSources[photoModalIndex]" class="max-h-[85vh] w-full object-contain rounded" />
      <button @click="closePhotoViewer" class="absolute top-2 right-2 bg-black/60 text-white px-3 py-1 rounded">Zamknij</button>
      <button @click="prevPhoto" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/60 text-white px-3 py-2 rounded">‚Äπ</button>
      <button @click="nextPhoto" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/60 text-white px-3 py-2 rounded">‚Ä∫</button>
      <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-white text-sm bg-black/40 px-2 py-1 rounded">{{ photoModalIndex+1 }} / {{ photoModalSources.length }}</div>
    </div>
  </div>

  </div>
  </div>

  <script src="/js/app.js?v=7"></script>
</body>
</html> 